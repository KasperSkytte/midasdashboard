---
title: "data"
author: "KSA"
date: "November 9, 2017"
output: html_document
---

#packages
```{r}
library(ampvis2)
library(tidyverse)
library(magrittr)
#library(phyloseq)
#load("data/rasmus2017digesterpaper.RData")
```

#functions
```{r}
fix_metadata <- function(data) {
  colnames(data$metadata)[1] <- "SampleID"
  if(!any(colnames(data$metadata) %in% "Date"))
    stop("No 'Date' variable found in metadata", call. = FALSE)
  if(!lubridate::is.Date(data$metadata$Date))
    stop("Date variable is not in date format")
  #if(any(is.na(data$metadata$Date)) | any(data$metadata$Date %in% ""))
  #  stop("dates contain NA values")
  data$metadata$Year <- as.character(lubridate::year(data$metadata$Date))
  
  #extract seasonal periods from dates
  WS <- as.Date("2012-12-15", format = "%Y-%m-%d") # Winter Solstice
  SE <- as.Date("2012-3-15",  format = "%Y-%m-%d") # Spring Equinox
  SS <- as.Date("2012-6-15",  format = "%Y-%m-%d") # Summer Solstice
  FE <- as.Date("2012-9-15",  format = "%Y-%m-%d") # Fall Equinox
  
  # Convert dates from any year to 2012 dates
  dates <- as.Date(strftime(data$metadata$Date, format="2012-%m-%d"))
  #extract periods and set factors for correct chronological order
  data$metadata$Period <- ifelse (dates >= WS | dates < SE, "Vinter", #winter
                                ifelse (dates >= SE & dates < SS, "Forår", #spring
                                        ifelse (dates >= SS & dates < FE, "Sommer", "Efterår"))) #summer, fall
  data$metadata$Period <- factor(data$metadata$Period, levels = c("Forår", "Sommer", "Efterår", "Vinter"))
  
  #check variables
  data$metadata <- data$metadata[,which(tolower(colnames(data$metadata)) %in% c("sampleid", 
                                                                                "plant",
                                                                                "year", 
                                                                                "period", 
                                                                                "date", 
                                                                                "svi", 
                                                                                "dsvi", 
                                                                                "reaktor",
                                                                                "temperature")), drop = FALSE]
  data$metadata$Plant <- trimws(data$metadata$Plant)
  data$metadata$Plant <- stringr::str_replace_all(data$metadata$Plant,
                           pattern = c("Aalborg E" = "Aalborg East",
                                       "Aalborg W" = "Aalborg West",
                                       "Aalborg oest" = "Aalborg East",
                                       "Aalborg Øst" = "Aalborg East",
                                       "Aalborg Vest" = "Aalborg West",
                                       "Esbjerg E" = "Esbjerg East",
                                       "Esbjerg W" = "Esbjerg West",
                                       "Esbjerg Vest" = "Esbjerg West",
                                       "aaby" = "Åby",
                                       "Odense NV" = "Odense NW",
                                       "Avedoere" = "Avedøre",
                                       "Damhusaaen" = "Damhusåen",
                                       "Egaa" = "Egå",
                                       "Ejby Moelle" = "Ejby Mølle",
                                       "Fornaes" = "Fornæs",
                                       "Hjoerring" = "Hjørring",
                                       "Naestved" = "Næstved",
                                       "Ringkoebing" = "Ringkøbing",
                                       "Soeholt" = "Søholt",
                                       "Sohoelt" = "Søholt"))
  return(data)
}

genusfunctions <- function(data, functions = c("FIL", "AOB", "NOB", "PAO", "GAO", "MET", "ACE", "FER", "DN", "Anammox")) {
  data <- ampvis2:::amp_rename(data)
  message("Normalising counts...")
  data$abund <- data$abund[,which(colSums(data$abund) != 0)] <- as.data.frame(apply(data$abund[,which(colSums(data$abund) != 0), drop = FALSE], 2, function(x) x/sum(x)*100))
  MiDAS_functions <- list()
  
  for(i in 1:length(functions)) {
    MiDAS_functions[[functions[i]]] <- data
    MiDAS_functions[[functions[i]]]$tax$Genus[which(MiDAS_functions[[functions[i]]]$tax$Genus %in% as.character(ampvis2::MiF$Genus[which(ampvis2::MiF[,functions[i]] %in% c("POS"))]))] <- functions[i]
    if(any(MiDAS_functions[[functions[i]]]$tax$Genus %in% functions[i])) {
      message(paste0("Calculating ", functions[i], "..."))
    MiDAS_functions[[functions[i]]] <- suppressMessages(ampvis2::amp_subset_taxa(MiDAS_functions[[functions[i]]], tax_vector = functions[i]))
    MiDAS_functions[[functions[i]]][["result"]] <- t(ampvis2::amp_heatmap(MiDAS_functions[[functions[i]]], tax_aggregate = "Genus", tax_show = "all", normalise = FALSE, textmap = TRUE))
    MiDAS_functions[[functions[i]]][["result"]] <- data.frame("SampleID" = as.character(rownames(MiDAS_functions[[functions[i]]][["result"]])), MiDAS_functions[[functions[i]]][["result"]])
    data$metadata <- merge(data$metadata, MiDAS_functions[[functions[i]]][["result"]], by = 1)
    }
  }
  rownames(data$metadata) <- data$metadata[,1]
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("FIL"))] <- "Filamentous"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("AOB"))] <- "Ammonia.Oxidizing.Bacteria"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("NOB"))] <- "Nitrite.Oxidizing.Bacteria"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("PAO"))] <- "Polyphosphate.Accumulating.Organisms"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("GAO"))] <- "Glygogen.Accumulating.Organisms"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("ACE"))] <- "Acetogens"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("FER"))] <- "Fermenters"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("DN"))] <- "Denitrifiers"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("MET"))] <- "Methanogens"
  colnames(data$metadata)[which(colnames(data$metadata) %in% c("Anammox"))] <- "Anammox"
  return(data)
}

periodAvg <- function(metadata, datecol = "Date") {
  WS <- as.Date("2012-12-15", format = "%Y-%m-%d") # Winter Solstice
  SE <- as.Date("2012-3-15",  format = "%Y-%m-%d") # Spring Equinox
  SS <- as.Date("2012-6-15",  format = "%Y-%m-%d") # Summer Solstice
  FE <- as.Date("2012-9-15",  format = "%Y-%m-%d") # Fall Equinox
  
  # Convert dates from any year to 2012 dates
  d <- as.Date(strftime(metadata[,datecol], format="2012-%m-%d"))
  
  metadata$PeriodAvg <- ifelse (d >= WS | d < SE, "2000-12-15", #winter
                                ifelse (d >= SE & d < SS, "2000-03-15", #spring
                                        ifelse (d >= SS & d < FE, "2000-06-15", "2000-09-15"))) #summer, fall
  metadata$PeriodAvg <- paste0(metadata$Year, "-", lubridate::month(metadata$PeriodAvg), "-", lubridate::day(metadata$PeriodAvg)) %>% lubridate::ymd()
  metadata <- group_by(metadata, PeriodAvg)
  metadata <- suppressWarnings(summarise_all(metadata, mean, na.rm = TRUE))
  metadata <- metadata[,apply(metadata, 2, function(x) !all(is.na(x)))]
  return(metadata)
}
```

#MiDAS (LATEST, USE THIS)
```{r}
metadata <- openxlsx::read.xlsx("data/[2018-12-3] data/MiDAS/metadata_ShinyApp_2018.xlsx", detectDates = TRUE)
otutable <- data.table::fread("data/[2018-12-3] data/MiDAS/otutable.txt", fill = TRUE)
MiDAS <- amp_load(otutable, metadata)
MiDAS <- fix_metadata(MiDAS)
MiDAS <- genusfunctions(MiDAS)
save(MiDAS, file = "appdata/MiDAS2.rda")
MiDAS_PeriodAvg <- periodAvg(MiDAS$metadata)
MiDAS_PeriodAvg$Date <- as.character(as.Date(MiDAS_PeriodAvg$Date))
save(MiDAS_PeriodAvg, file = "appdata/MiDAS_PeriodAvg.rda")
```


#digester archaea
```{r}
metadata <- openxlsx::read.xlsx("data/MiDAD_Quarterly_samples_2006-2018_OTUs/archea_V3V5/metadata_midad_archaea.xlsx", 
                                sheet = 2, 
                                detectDates = TRUE)
metadata <- filter(metadata, !Plant %in% c("POS CTRL", "NEG CTRL"))
metadata$Date <- lubridate::ymd(metadata$Date)
otutable <- data.table::fread("data/MiDAD_Quarterly_samples_2006-2018_OTUs/archea_V3V5/otutable.txt", fill = TRUE)
digester_archaea <- amp_load(otutable, metadata)
digester_archaea <- fix_metadata(digester_archaea)
digester_archaea$metadata$Reaktor[which(is.na(digester_archaea$metadata$Reaktor) | digester_archaea$metadata$Reaktor == "")] <- NA
digester_archaea$metadata <- mutate(digester_archaea$metadata, Plant = paste0(Plant, " R-", Reaktor))
digester_archaea <- genusfunctions(digester_archaea)
save(digester_archaea, file = "appdata/digester_archaea.rda")
digester_archaea_PeriodAvg <- periodAvg(digester_archaea$metadata)
save(digester_archaea_PeriodAvg, file = "appdata/digester_archaea_PeriodAvg.rda")
```

#digester bacteria (LATEST, USE THIS)
```{r}
metadata <- openxlsx::read.xlsx("data/MiDAD_Quarterly_samples_2006-2018_OTUs/bacteria_V1V3/metadata_midad_bacteria_with_add_files.xlsx",
                                sheet = "metadata", 
                                detectDates = TRUE)
colnames(metadata)[7] <- "Reaktor" #"Reactor" = "Reaktor"
metadata$Date <- lubridate::ymd(metadata$Date)
otutable <- data.table::fread("data/MiDAD_Quarterly_samples_2006-2018_OTUs/bacteria_V1V3/otutable.txt", fill = TRUE)
digester_bacteria <- amp_load(otutable, metadata)
digester_bacteria <- fix_metadata(digester_bacteria)
digester_bacteria$metadata$Reaktor[which(is.na(digester_bacteria$metadata$Reaktor) | digester_bacteria$metadata$Reaktor == "")] <- NA
digester_bacteria$metadata <- mutate(digester_bacteria$metadata, Plant = paste0(Plant, " R-", Reaktor))
digester_bacteria <- genusfunctions(digester_bacteria)
save(digester_bacteria, file = "appdata/digester_bacteria.rda")
digester_bacteria_PeriodAvg <- periodAvg(digester_bacteria$metadata)
save(digester_bacteria_PeriodAvg, file = "appdata/digester_bacteria_PeriodAvg.rda")
```

#biobank, all WWPTs (LATEST, USE THIS)
```{r}
metadata <- openxlsx::read.xlsx("data/[2018-12-3] data/biobank time series/all plants/metadata_BioBank_ShinyApp_mni.xlsx", detectDates = TRUE)
otutable <- data.table::fread("data/[2018-12-3] data/biobank time series/all plants/otutable.txt", fill = TRUE)
biobank2015_2018 <- amp_load(otutable, metadata)
biobank2015_2018 <- amp_subset_samples(biobank2015_2018, !Plant %in% c("AAU", "PCRPOS", "PCRNEG", "NA"))
biobank2015_2018$metadata <- mutate_at(biobank2015_2018$metadata, vars(Date), lubridate::ymd)
biobank2015_2018 <- fix_metadata(biobank2015_2018)
biobank2015_2018 <- genusfunctions(biobank2015_2018)
save(biobank2015_2018, file = "appdata/biobank2015_2018.rda")
biobank2015_2018_PeriodAvg <- periodAvg(biobank2015_2018$metadata)
save(biobank2015_2018_PeriodAvg, file = "appdata/biobank2015_2018_PeriodAvg.rda")
```

#biobank, AAW (LATEST, USE THIS)
```{r}
metadata <- openxlsx::read.xlsx("data/[2018-12-3] data/biobank time series/AAV/metadata_BIOBANK_Aalborg_Vest_2.xlsx", detectDates = TRUE)
otutable <- data.table::fread("data/[2018-12-3] data/biobank time series/AAV/otutable.txt", fill = TRUE)
AalborgW <- amp_load(otutable, metadata)
AalborgW <- fix_metadata(AalborgW)
AalborgW <- genusfunctions(AalborgW)
save(AalborgW, file = "appdata/AalborgW.rda")

##### DSVI #####
AalborgW_DSVI <- openxlsx::read.xlsx("data/[2018-12-3] data/biobank time series/AAV/DSVI_BIOBANK_AalborgVest_2015-2018.xlsx", detectDates = TRUE)
AalborgW_PeriodAvg <- periodAvg(AalborgW$metadata)
save(AalborgW_PeriodAvg, file = "appdata/AalborgW_PeriodAvg.rda")
```

#egaamarselisborg CP332 hasteprøver
```{r}
#data copied from CP-Ongoing 18 may 2018
egaamarselisborg <- amp_subset_samples(amp_load(otutable = read.delim("data/aarhusvand CP332/otutable.txt", check.names = FALSE), metadata = openxlsx::read.xlsx("data/aarhusvand CP332/CP332_metadata.xlsx", rows = 1:21, cols = c(1,9,11))), normalise = TRUE)
colnames(egaamarselisborg$metadata) <- c("SampleID", "Plant", "Date")
egaamarselisborg$metadata$Date <- as.Date(egaamarselisborg$metadata$Date, origin = "1899-12-30", format = "%Y-%m-%d")
egaamarselisborg$metadata <- genusfunctions(egaamarselisborg)
save(egaamarselisborg, file = "appdata/egaamarselisborg(CP332).rda")
```


##### OLD #####

#MiDAS (old, and probably doesn't work anymore)
```{r, eval = FALSE}
load("data/MiDAS.rda")
#functions
MiDAS$metadata <- genusfunctions(MiDAS)
save(MiDAS, file = "data/MiDAS2.rda")

#average functions
MiDAS_PeriodAvg <- periodAvg(MiDAS$metadata)
save(MiDAS_PeriodAvg, file = "data/MiDAS_PeriodAvg.rda")
```

#MiDASapr2018 (old, and probably doesn't work anymore)
```{r, eval = FALSE}
metadata <- readxl::read_excel("data/MiDASapr2018/metadata.xlsx")
otutable <- data.table::fread("data/MiDASapr2018/otutable.csv", fill = TRUE)
MiDASapr2018 <- amp_load(otutable, metadata)
MiDASapr2018 <- fix_metadata(MiDASapr2018)
#MiDASapr2018$metadata %<>% left_join(MiDAS$metadata[,-c(2:9)], by = "SampleID")
MiDASapr2018 <- genusfunctions(MiDASapr2018)
MiDAS <- MiDASapr2018
save(MiDAS, file = "data/MiDAS2.rda")
#openxlsx::write.xlsx(arrange(filter(test, Plant %in% c("Aalborg East", "Aalborg West")), Date), "test.xlsx")
MiDAS_PeriodAvg <- periodAvg(MiDAS$metadata)
MiDAS_PeriodAvg$Date <- as.character(as.Date(MiDAS_PeriodAvg$Date))
save(MiDAS_PeriodAvg, file = "data/MiDAS_PeriodAvg.rda")
```

#digester archaea (old, and probably doesn't work anymore)
```{r, eval = FALSE}
load("data/digester_archaea.rda")
#functions
digester_archaea$metadata <- digester_archaea$metadata[,c("SampleID", "Date", "Plant", "Temperature")]
digester_archaea$metadata <- genusfunctions(digester_archaea)
save(digester_archaea, file = "data/digester_archaea.rda")

#average functions
digester_archaea_PeriodAvg <- periodAvg(digester_archaea$metadata)
save(digester_archaea_PeriodAvg, file = "data/digester_archaea_PeriodAvg.rda")
```

#digester bacteria (old, and probably doesn't work anymore)
```{r, eval = FALSE}
#load("data/digester_bacteria_old.rda") #old
load("data/MiDAD (rådnetanke) data/digester_new.rda") #new
#functions
digester_bacteria$metadata <- digester_bacteria$metadata[,1:7]
digester_bacteria$metadata <- genusfunctions(digester_bacteria)

#fix Plant names
digester_bacteria <- fix_metadata(digester_bacteria)

#save
save(digester_bacteria, file = "data/digester_bacteria.rda")

#average functions
digester_bacteria_PeriodAvg <- periodAvg(digester_bacteria$metadata)
save(digester_bacteria_PeriodAvg, file = "data/digester_bacteria_PeriodAvg.rda")
```

#AalborgEW timeseries (old, and probably doesn't work anymore)
```{r, eval = FALSE}
otutable <- read.csv("data/fggyt/otutable.txt", check.names = FALSE, sep = "\t")
metadata <- read.csv("data/fggyt/metadata.txt", check.names = FALSE, sep = "\t", colClasses = c("character"))[,c(1,2,4,5,7,8,9)] %>% 
  filter(Year %in% c("2012", "2013", "2014", "2015"))
metadata$Date <- ymd(metadata$Date)
metadata$DSVI <- as.numeric(metadata$DSVI)
metadata$Plant[which(metadata$Plant %in% c("Aalborg E"))] <- "Aalborg East"
metadata$Plant[which(metadata$Plant %in% c("Aalborg W"))] <- "Aalborg West"
AalborgEW <- amp_load(otutable,metadata)
AalborgEW$abund <- as.data.frame(apply(AalborgEW$abund, 2, function(x) x/sum(x)*100))

#functions
AalborgEW$metadata <- genusfunctions(AalborgEW)
save(AalborgEW, file = "data/AalborgEW.rda")

#average functions
AalborgEW_PeriodAvg <- periodAvg(AalborgEW$metadata)
save(AalborgEW_PeriodAvg, file = "data/AalborgEW_PeriodAvg.rda")
```
